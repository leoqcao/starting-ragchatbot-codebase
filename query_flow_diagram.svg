<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font: bold 16px Arial; text-anchor: middle; }
      .section-title { font: bold 14px Arial; text-anchor: middle; }
      .step-text { font: 12px Arial; text-anchor: middle; }
      .component { font: 11px Arial; text-anchor: middle; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .data-arrow { stroke: #0066cc; stroke-width: 2; fill: none; marker-end: url(#bluearrowhead); }
      .frontend-box { fill: #e8f4fd; stroke: #1976d2; stroke-width: 2; }
      .backend-box { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 2; }
      .rag-box { fill: #e8f5e8; stroke: #388e3c; stroke-width: 2; }
      .ai-box { fill: #fff3e0; stroke: #f57c00; stroke-width: 2; }
      .tool-box { fill: #fce4ec; stroke: #c2185b; stroke-width: 2; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
    <marker id="bluearrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#0066cc" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" class="title">RAG Chatbot Query Flow: Frontend to Backend</text>

  <!-- Frontend Section -->
  <g id="frontend">
    <rect x="50" y="60" width="250" height="120" class="frontend-box" rx="8"/>
    <text x="175" y="80" class="section-title">FRONTEND</text>
    
    <!-- Step 1: User Input -->
    <rect x="70" y="90" width="210" height="25" fill="#bbdefb" rx="4"/>
    <text x="175" y="107" class="step-text">1. User types query in chat input</text>
    
    <!-- Step 2: Event Handler -->
    <rect x="70" y="120" width="210" height="25" fill="#bbdefb" rx="4"/>
    <text x="175" y="137" class="step-text">2. sendMessage() triggered</text>
    
    <!-- Step 3: API Call -->
    <rect x="70" y="150" width="210" height="25" fill="#bbdefb" rx="4"/>
    <text x="175" y="167" class="step-text">3. POST /api/query with session_id</text>
  </g>

  <!-- Backend API Section -->
  <g id="backend-api">
    <rect x="400" y="60" width="250" height="120" class="backend-box" rx="8"/>
    <text x="525" y="80" class="section-title">BACKEND API</text>
    
    <!-- Step 4: FastAPI Endpoint -->
    <rect x="420" y="90" width="210" height="25" fill="#e1bee7" rx="4"/>
    <text x="525" y="107" class="step-text">4. FastAPI /api/query endpoint</text>
    
    <!-- Step 5: Session Management -->
    <rect x="420" y="120" width="210" height="25" fill="#e1bee7" rx="4"/>
    <text x="525" y="137" class="step-text">5. Create/get session ID</text>
    
    <!-- Step 6: RAG Call -->
    <rect x="420" y="150" width="210" height="25" fill="#e1bee7" rx="4"/>
    <text x="525" y="167" class="step-text">6. Call rag_system.query()</text>
  </g>

  <!-- RAG System Section -->
  <g id="rag-system">
    <rect x="50" y="220" width="250" height="150" class="rag-box" rx="8"/>
    <text x="175" y="240" class="section-title">RAG SYSTEM</text>
    
    <!-- Step 7: Query Processing -->
    <rect x="70" y="250" width="210" height="25" fill="#c8e6c9" rx="4"/>
    <text x="175" y="267" class="step-text">7. Process query in RAGSystem</text>
    
    <!-- Step 8: History -->
    <rect x="70" y="280" width="210" height="25" fill="#c8e6c9" rx="4"/>
    <text x="175" y="297" class="step-text">8. Get conversation history</text>
    
    <!-- Step 9: AI Generator -->
    <rect x="70" y="310" width="210" height="25" fill="#c8e6c9" rx="4"/>
    <text x="175" y="327" class="step-text">9. Call ai_generator.generate()</text>
    
    <!-- Step 10: Session Update -->
    <rect x="70" y="340" width="210" height="25" fill="#c8e6c9" rx="4"/>
    <text x="175" y="357" class="step-text">17. Update session history</text>
  </g>

  <!-- AI Generation Section -->
  <g id="ai-generation">
    <rect x="400" y="220" width="250" height="180" class="ai-box" rx="8"/>
    <text x="525" y="240" class="section-title">AI GENERATION</text>
    
    <!-- Step 10: Claude API -->
    <rect x="420" y="250" width="210" height="25" fill="#ffe0b2" rx="4"/>
    <text x="525" y="267" class="step-text">10. Initial Claude API call</text>
    
    <!-- Step 11: Tool Decision -->
    <rect x="420" y="280" width="210" height="25" fill="#ffe0b2" rx="4"/>
    <text x="525" y="297" class="step-text">11. Claude decides: use search tool?</text>
    
    <!-- Step 15: Tool Results -->
    <rect x="420" y="310" width="210" height="25" fill="#ffe0b2" rx="4"/>
    <text x="525" y="327" class="step-text">15. Receive tool search results</text>
    
    <!-- Step 16: Final Response -->
    <rect x="420" y="340" width="210" height="25" fill="#ffe0b2" rx="4"/>
    <text x="525" y="357" class="step-text">16. Generate final answer</text>
    
    <!-- Step 18: API Response -->
    <rect x="420" y="370" width="210" height="25" fill="#ffe0b2" rx="4"/>
    <text x="525" y="387" class="step-text">18. Return structured response</text>
  </g>

  <!-- Tool System Section -->
  <g id="tool-system">
    <rect x="750" y="220" width="300" height="180" class="tool-box" rx="8"/>
    <text x="900" y="240" class="section-title">SEARCH TOOL SYSTEM</text>
    
    <!-- Step 12: Tool Execution -->
    <rect x="770" y="250" width="260" height="25" fill="#f8bbd9" rx="4"/>
    <text x="900" y="267" class="step-text">12. Execute search_course_content tool</text>
    
    <!-- Step 13: Vector Search -->
    <rect x="770" y="280" width="260" height="25" fill="#f8bbd9" rx="4"/>
    <text x="900" y="297" class="step-text">13. Search vector store (embeddings)</text>
    
    <!-- Step 14: Format Results -->
    <rect x="770" y="310" width="260" height="25" fill="#f8bbd9" rx="4"/>
    <text x="900" y="327" class="step-text">14. Format results with course/lesson info</text>
    
    <!-- Components -->
    <rect x="770" y="340" width="120" height="50" fill="#fce4ec" stroke="#ad1457" rx="4"/>
    <text x="830" y="360" class="component">Vector Store</text>
    <text x="830" y="375" class="component">(ChromaDB)</text>
    
    <rect x="910" y="340" width="120" height="50" fill="#fce4ec" stroke="#ad1457" rx="4"/>
    <text x="970" y="360" class="component">Document</text>
    <text x="970" y="375" class="component">Processor</text>
  </g>

  <!-- Response Flow Section -->
  <g id="response-flow">
    <rect x="50" y="450" width="600" height="100" class="frontend-box" rx="8"/>
    <text x="350" y="470" class="section-title">RESPONSE FLOW</text>
    
    <!-- Step 19: Source Collection -->
    <rect x="70" y="480" width="180" height="25" fill="#bbdefb" rx="4"/>
    <text x="160" y="497" class="step-text">19. Collect sources from tools</text>
    
    <!-- Step 20: Frontend Display -->
    <rect x="270" y="480" width="180" height="25" fill="#bbdefb" rx="4"/>
    <text x="360" y="497" class="step-text">20. Update chat UI with answer</text>
    
    <!-- Step 21: Sources Display -->
    <rect x="470" y="480" width="160" height="25" fill="#bbdefb" rx="4"/>
    <text x="550" y="497" class="step-text">21. Show collapsible sources</text>
  </g>

  <!-- Data Storage -->
  <g id="data-storage">
    <rect x="750" y="450" width="300" height="120" class="rag-box" rx="8"/>
    <text x="900" y="470" class="section-title">DATA STORAGE</text>
    
    <rect x="770" y="485" width="120" height="40" fill="#e8f5e8" stroke="#4caf50" rx="4"/>
    <text x="830" y="500" class="component">Course</text>
    <text x="830" y="515" class="component">Documents</text>
    
    <rect x="910" y="485" width="120" height="40" fill="#e8f5e8" stroke="#4caf50" rx="4"/>
    <text x="970" y="500" class="component">Session</text>
    <text x="970" y="515" class="component">History</text>
    
    <rect x="770" y="535" width="260" height="25" fill="#c8e6c9" rx="4"/>
    <text x="900" y="552" class="step-text">Embedded course chunks for semantic search</text>
  </g>

  <!-- Flow Arrows -->
  <!-- Frontend to Backend -->
  <line x1="300" y1="120" x2="400" y2="120" class="arrow"/>
  
  <!-- Backend to RAG -->
  <line x1="420" y1="160" x2="300" y2="160" class="arrow"/>
  <line x1="300" y1="180" x2="300" y2="220" class="arrow"/>
  
  <!-- RAG to AI -->
  <line x1="300" y1="320" x2="400" y2="320" class="arrow"/>
  
  <!-- AI to Tools -->
  <line x1="650" y1="290" x2="750" y2="290" class="arrow"/>
  
  <!-- Tools back to AI -->
  <line x1="750" y1="320" x2="650" y2="320" class="arrow"/>
  
  <!-- AI back to RAG -->
  <line x1="420" y1="350" x2="300" y2="350" class="arrow"/>
  
  <!-- RAG to Response -->
  <line x1="175" y1="370" x2="175" y2="450" class="arrow"/>
  
  <!-- Backend to Response -->
  <line x1="525" y1="400" x2="525" y2="430" class="arrow"/>
  <line x1="525" y1="430" x2="360" y2="430" class="arrow"/>
  <line x1="360" y1="430" x2="360" y2="450" class="arrow"/>

  <!-- Data flow arrows -->
  <line x1="900" y1="340" x2="900" y2="320" class="data-arrow"/>
  <line x1="175" y1="340" x2="830" y2="485" class="data-arrow"/>

  <!-- Legend -->
  <g id="legend">
    <rect x="50" y="620" width="500" height="120" fill="none" stroke="#ccc" stroke-width="1" rx="8"/>
    <text x="300" y="640" class="section-title">LEGEND</text>
    
    <rect x="70" y="650" width="20" height="15" class="frontend-box"/>
    <text x="100" y="662" class="component">Frontend (JavaScript)</text>
    
    <rect x="70" y="670" width="20" height="15" class="backend-box"/>
    <text x="100" y="682" class="component">Backend API (FastAPI)</text>
    
    <rect x="70" y="690" width="20" height="15" class="rag-box"/>
    <text x="100" y="702" class="component">RAG System (Python)</text>
    
    <rect x="270" y="650" width="20" height="15" class="ai-box"/>
    <text x="300" y="662" class="component">AI Generation (Claude)</text>
    
    <rect x="270" y="670" width="20" height="15" class="tool-box"/>
    <text x="300" y="682" class="component">Search Tools</text>
    
    <line x1="70" y1="715" x2="90" y2="715" class="arrow"/>
    <text x="100" y="720" class="component">Process Flow</text>
    
    <line x1="270" y1="715" x2="290" y2="715" class="data-arrow"/>
    <text x="300" y="720" class="component">Data Access</text>
  </g>

  <!-- Key Files References -->
  <g id="key-files">
    <rect x="600" y="620" width="450" height="120" fill="none" stroke="#ccc" stroke-width="1" rx="8"/>
    <text x="825" y="640" class="section-title">KEY FILES</text>
    
    <text x="620" y="657" class="component">• frontend/script.js:45 - sendMessage()</text>
    <text x="620" y="672" class="component">• backend/app.py:56 - /api/query endpoint</text>
    <text x="620" y="687" class="component">• backend/rag_system.py:102 - query processing</text>
    <text x="620" y="702" class="component">• backend/ai_generator.py:43 - Claude integration</text>
    <text x="620" y="717" class="component">• backend/search_tools.py:52 - tool execution</text>
  </g>
</svg>